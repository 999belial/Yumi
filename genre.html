<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Аніме за жанром</title>
    <style>
      body {
        background-color: #000;
        color: #ddd;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-image: url("assets/img/anime/backgraund.png");
        background-size: cover;
        background-position: top center;
      }

      nav {
        background-color: rgba(26, 10, 58, 0.9);
        padding: 15px 30px;
        font-family: Impact, sans-serif;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      nav a {
        color: #ddd;
        text-decoration: none;
        font-size: 18px;
      }

      nav a:hover {
        color: rgb(157, 13, 219);
      }

      nav .current-genre {
        color: rgba(157, 149, 204, 0.95);
        font-size: 20px;
        font-weight: bold;
      }

      nav select {
        background-color: #2e1b5c;
        color: #ddd;
        border: none;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 16px;
        cursor: pointer;
        font-family: Arial, sans-serif;
      }

      nav select:hover {
        background-color: rgb(157, 13, 219);
        color: #fff;
      }

      #anime-list {
        max-width: 900px;
        margin: 40px auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
      }
      .anime-card {
        background-color: #1a0a3a;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(157, 149, 204, 0.6);
        text-align: center;
        padding-bottom: 10px;
        color: #ddd;
      }
      .anime-card img {
        width: 100%;
        height: auto;
        border-bottom: 1px solid rgba(157, 149, 204, 0.5);
      }
      .anime-card h3 {
        margin: 10px 5px 5px;
        font-size: 18px;
        font-family: Impact, sans-serif;
        color: rgba(157, 149, 204, 0.95);
      }
      .anime-card p {
        font-size: 14px;
        padding: 0 10px;
        height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="./index.html">ГОЛОВНА</a>
      <span class="current-genre" id="current-genre-label"></span>
      <select id="genre-select" aria-label="Вибір жанру">
        <option value="">Виберіть жанр</option>
        <option value="Action">Екшн</option>
        <option value="Adventure">Пригоди</option>
        <option value="Comedy">Комедія</option>
        <option value="Drama">Драма</option>
        <option value="Ecchi">Еччі</option>
        <option value="Fantasy">Фентезі</option>
        <option value="Harem">Гарем</option>
        <option value="Hentai">Хентай</option>
        <option value="Historical">Історичний</option>
        <option value="Horror">Жахи</option>
        <option value="Josei">Дзосей</option>
        <option value="Kids">Дитячий</option>
        <option value="Magic">Магія</option>
        <option value="Martial Arts">Бойові мистецтва</option>
        <option value="Mecha">Меха</option>
        <option value="Military">Військовий</option>
        <option value="Music">Музика</option>
        <option value="Mystery">Містерія</option>
        <option value="Parody">Пародія</option>
        <option value="Psychological">Психологічний</option>
        <option value="Romance">Романтика</option>
        <option value="School">Школа</option>
        <option value="Sci-Fi">Наукова фантастика</option>
        <option value="Seinen">Сейнєн</option>
        <option value="Shoujo">Шодзьо</option>
        <option value="Shoujo Ai">Шодзьо Ай</option>
        <option value="Shounen">Шонен</option>
        <option value="Shounen Ai">Шонен Ай</option>
        <option value="Slice of Life">Слайс оф лайф</option>
        <option value="Sports">Спорт</option>
        <option value="Super Power">Суперсила</option>
        <option value="Supernatural">Надприродне</option>
        <option value="Thriller">Трилер</option>
        <option value="Vampire">Вампір</option>
        <option value="Yaoi">Яой</option>
        <option value="Yuri">Юрі</option>
      </select>
    </nav>

    <section id="anime-list"></section>

    <script>
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      async function fetchAnimeByGenre(genre) {
        if (!genre) return [];
        const query = `
      query ($genre: String) {
        Page(perPage: 20) {
          media(genre_in: [$genre], type: ANIME, sort: POPULARITY_DESC) {
            id
            title {
              romaji
              english
            }
            coverImage {
              medium
            }
            description(asHtml: false)
          }
        }
      }
    `;

        const variables = { genre };

        try {
          const response = await fetch("https://graphql.anilist.co", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query, variables }),
          });
          const data = await response.json();
          return data.data.Page.media;
        } catch (err) {
          console.error(err);
          return [];
        }
      }

      function renderAnimeList(animeArray) {
        const container = document.getElementById("anime-list");
        if (!animeArray || animeArray.length === 0) {
          container.innerHTML =
            '<p style="color:#ccc; text-align:center;">Аніме не знайдено</p>';
          return;
        }
        container.innerHTML = animeArray
          .map(
            (anime) => `
      <div class="anime-card">
        <img src="${anime.coverImage.medium}" alt="${anime.title.romaji}" />
        <h3>${anime.title.english || anime.title.romaji}</h3>
        <p>${
          anime.description
            ? anime.description.substring(0, 100) + "..."
            : "Опис відсутній"
        }</p>
      </div>
    `
          )
          .join("");
      }

      async function loadGenre(genre) {
        const label = document.getElementById("current-genre-label");
        if (!genre) {
          label.textContent = "";
          document.getElementById("anime-list").innerHTML =
            '<p style="color:#ccc; text-align:center;">Будь ласка, виберіть жанр</p>';
          return;
        }
        label.textContent = `Жанр: ${genre}`;
        document.getElementById("anime-list").innerHTML =
          '<p style="color:#ccc; text-align:center;">Завантаження...</p>';
        const anime = await fetchAnimeByGenre(genre);
        renderAnimeList(anime);
      }

      document.addEventListener("DOMContentLoaded", () => {
        const genreSelect = document.getElementById("genre-select");
        const urlGenre = getQueryParam("genre");

        if (urlGenre) {
          genreSelect.value = urlGenre;
          loadGenre(urlGenre);
        } else {
          document.getElementById("anime-list").innerHTML =
            '<p style="color:#ccc; text-align:center;">Будь ласка, виберіть жанр</p>';
        }

        genreSelect.addEventListener("change", () => {
          const selectedGenre = genreSelect.value;
          if (selectedGenre) {
            // Обновляем URL без перезагрузки
            const newUrl = new URL(window.location);
            newUrl.searchParams.set("genre", selectedGenre);
            window.history.pushState({}, "", newUrl);

            loadGenre(selectedGenre);
          } else {
            document.getElementById("current-genre-label").textContent = "";
            document.getElementById("anime-list").innerHTML =
              '<p style="color:#ccc; text-align:center;">Будь ласка, виберіть жанр</p>';
            // Убираем параметр из URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete("genre");
            window.history.pushState({}, "", newUrl);
          }
        });
      });
    </script>
  </body>
</html>
